const a=S;function n(){const AB=['websocket','charCodeAt','enqueue','status','Upgrade','trace','rawDataIndex','safeCloseWebSocket\x20error','webSocketServer\x20has\x20error','\x0a\x20\x20client-fingerprint:\x20chrome\x0a\x20\x20ws-opts:\x0a\x20\x20\x20\x20path:\x20\x22/?ed=2048\x22\x0a\x20\x20\x20\x20headers:\x0a\x20\x20\x20\x20\x20\x20host:\x20','604204LLTBcu','5ZvWcqd','POST','d342d11e-d424-4583-b36e-524ab1f0afa4','tcp\x20','\x20is\x20not\x20support,\x20command\x2001-tcp,02-udp,03-mux','Content-Type','isUDP','\x0a\x20\x20network:\x20ws\x0a\x20\x20tls:\x20true\x0a\x20\x20udp:\x20false\x0a\x20\x20sni:\x20','vlessVersion','close','udp\x20','?encryption=none&security=tls&sni=','exception','body','portRemote','join','test','1927908VLlcaE','invalid\x20data','slice','error','warn','1904888YcPRUe','UUID','getUint16','values','10uzJlJL','catch','webSocket','write','stack','info','hasError','1jbcTXf','remoteConnection!.readable\x20is\x20close\x20with\x20hasIncomingData\x20is\x20','readyState','addEventListener','readableWebSocketStream\x20is\x20abort','pipeTo','webSocket.readyState\x20is\x20not\x20open,\x20maybe\x20close','(((.+)+)+)+$','1882503YSNQmG','closed','search','\x0a\x20\x20server:\x20','connected\x20to\x20','dns\x20udp\x20has\x20error','336QjAmPC','releaseLock','\x0a---------------------------------------------------------------\x0a################################################################\x0a','byteLength','stringify','bind','send','toLowerCase','1396512jZDVCm','sec-websocket-protocol','value','headers','arrayBuffer','earlyData','\x0a\x20\x20port:\x20443\x0a\x20\x20uuid:\x20','table','&fp=randomized&type=ws&host=','toString','addressRemote','hostname',':443','pathname','getWriter','message','59577JcYARA','Not\x20found','retry\x20tcpSocket\x20closed\x20error','console','log','Host','constructor','push','__proto__','random','readableWebSocketStream\x20is\x20close','vless','replace','readable','text/plain;charset=utf-8','remoteSocketToWS\x20has\x20exception\x20','get','readableWebSocketStream\x20pipeTo\x20error','uuid\x20is\x20not\x20valid','\x0a---------------------------------------------------------------\x0a################################################################\x0aclash-meta\x0a---------------------------------------------------------------\x0a-\x20type:\x20vless\x0a\x20\x20name:\x20','remoteConnection!.readable\x20abort','writable','command\x20','invalid\x20user','apply','9920779OpYFyO','data','doh\x20success\x20and\x20dns\x20message\x20length\x20is\x20','addressType','https://1.1.1.1/dns-query','prototype'];n=function(){return AB;};return n();}(function(A,t){const p=S,s=A();while(!![]){try{const H=-parseInt(p(0xe4))/0x1*(parseInt(p(0xc2))/0x2)+-parseInt(p(0xd4))/0x3+-parseInt(p(0xd9))/0x4*(-parseInt(p(0xc3))/0x5)+-parseInt(p(0xfa))/0x6+-parseInt(p(0x10a))/0x7*(-parseInt(p(0xf2))/0x8)+-parseInt(p(0xec))/0x9+parseInt(p(0xdd))/0xa*(parseInt(p(0x123))/0xb);if(H===t)break;else s['push'](s['shift']());}catch(u){s['push'](s['shift']());}}}(n,0x552f4));import{connect}from'cloudflare:sockets';let userID=a(0xc5),proxyIP='';function S(A,t){const s=n();return S=function(H,u){H=H-0xb8;let V=s[H];return V;},S(A,t);}if(!isValidUUID(userID))throw new Error(a(0x11c));export default{async 'fetch'(u,V,B){const F=a;try{userID=V[F(0xda)]||userID,proxyIP=V['PROXYIP']||proxyIP;const Y=u[F(0xfd)][F(0x11a)](F(0xbc));if(!Y||Y!==F(0xb8)){const O=new URL(u['url']);switch(O[F(0x107)]){case'/':const J={};J[F(0xbb)]=0xc8;return new Response(JSON[F(0xf6)](u['cf']),J);case'/'+userID:{const d=getVLESSConfig(userID,u[F(0xfd)][F(0x11a)](F(0x10f))),X={};X[F(0xc8)]=F(0x118);const K={};return K['status']=0xc8,K['headers']=X,new Response(''+d,K);}default:const q={};q[F(0xbb)]=0x194;return new Response(F(0x10b),q);}}else return await vlessOverWSHandler(u);}catch(o){let z=o;return new Response(z[F(0x103)]());}}};async function vlessOverWSHandler(s){const b=a,H=new WebSocketPair(),[u,V]=Object[b(0xdc)](H);V['accept']();let B='',Y='';const O=(g,M)=>{const E=b;console[E(0x10e)]('['+B+':'+Y+']\x20'+g,M||'');},J=s['headers'][b(0x11a)](b(0xfb))||'',q=makeReadableWebSocketStream(V,J,O),d={};d[b(0xfc)]=null;let X=d,K=null,o=![];q[b(0xe9)](new WritableStream({async 'write'(g,M){const w=b;if(o&&K)return K(g);if(X[w(0xfc)]){const l=X['value'][w(0x11f)][w(0x108)]();await l[w(0xe0)](g),l['releaseLock']();return;}const {hasError:W,message:L,portRemote:portRemote=0x1bb,addressRemote:addressRemote='',rawDataIndex:N,vlessVersion:vlessVersion=new Uint8Array([0x0,0x0]),isUDP:C}=processVlessHeader(g,userID);B=addressRemote,Y=portRemote+'--'+Math[w(0x113)]()+'\x20'+(C?w(0xcd):w(0xc6))+'\x20';if(W){throw new Error(L);return;}if(C){if(portRemote===0x35)o=!![];else{throw new Error('UDP\x20proxy\x20only\x20enable\x20for\x20DNS\x20which\x20is\x20port\x2053');return;}}const R=new Uint8Array([vlessVersion[0x0],0x0]),I=g[w(0xd6)](N);if(o){const {write:m}=await handleUDPOutBound(V,R,O);K=m,K(I);return;}handleTCPOutBound(X,addressRemote,portRemote,I,V,R,O);},'close'(){const P=b;O(P(0x114));},'abort'(g){const e=b;O(e(0xe8),JSON['stringify'](g));}}))[b(0xde)](g=>{const T=b;O(T(0x11b),g);});const z={};return z[b(0xbb)]=0x65,z[b(0xdf)]=u,new Response(null,z);}async function handleTCPOutBound(A,t,s,H,u,V,B){async function Y(q,d){const y=S,X={};X[y(0x105)]=q,X['port']=d;const K=connect(X);A[y(0xfc)]=K,B(y(0xf0)+q+':'+d);const o=K[y(0x11f)]['getWriter']();return await o[y(0xe0)](H),o[y(0xf3)](),K;}async function O(){const f=S,q=await Y(proxyIP||t,s);q[f(0xed)]['catch'](d=>{const r=f;console[r(0x10e)](r(0x10c),d);})['finally'](()=>{safeCloseWebSocket(u);}),remoteSocketToWS(q,u,V,null,B);}const J=await Y(t,s);remoteSocketToWS(J,u,V,O,B);}function makeReadableWebSocketStream(A,t,s){let H=![];const u=new ReadableStream({'start'(V){const v=S;A[v(0xe7)](v(0x109),O=>{const h=v;if(H)return;const J=O[h(0x124)];V[h(0xba)](J);}),A[v(0xe7)](v(0xcc),()=>{const x=v;safeCloseWebSocket(A);if(H)return;V[x(0xcc)]();}),A[v(0xe7)](v(0xd7),O=>{const j=v;s(j(0xc0)),V[j(0xd7)](O);});const {earlyData:B,error:Y}=base64ToArrayBuffer(t);if(Y)V[v(0xd7)](Y);else B&&V[v(0xba)](B);},'pull'(V){},'cancel'(V){if(H)return;s('ReadableStream\x20was\x20canceled,\x20due\x20to\x20'+V),H=!![],safeCloseWebSocket(A);}});return u;}function processVlessHeader(B,Y){const U=a;if(B[U(0xf5)]<0x18){const I={};return I['hasError']=!![],I[U(0x109)]=U(0xd5),I;}const O=new Uint8Array(B[U(0xd6)](0x0,0x1));let J=![],q=![];stringify(new Uint8Array(B['slice'](0x1,0x11)))===Y&&(J=!![]);if(!J){const l={};return l[U(0xe3)]=!![],l['message']=U(0x121),l;}const d=new Uint8Array(B[U(0xd6)](0x11,0x12))[0x0],X=new Uint8Array(B['slice'](0x12+d,0x12+d+0x1))[0x0];if(X===0x1){}else{if(X===0x2)q=!![];else{const m={};return m[U(0xe3)]=!![],m[U(0x109)]=U(0x120)+X+U(0xc7),m;}}const K=0x12+d+0x1,o=B['slice'](K,K+0x2),z=new DataView(o)[U(0xdb)](0x0);let g=K+0x2;const M=new Uint8Array(B['slice'](g,g+0x1)),W=M[0x0];let L=0x0,N=g+0x1,C='';switch(W){case 0x1:L=0x4,C=new Uint8Array(B[U(0xd6)](N,N+L))[U(0xd2)]('.');break;case 0x2:L=new Uint8Array(B[U(0xd6)](N,N+0x1))[0x0],N+=0x1,C=new TextDecoder()['decode'](B['slice'](N,N+L));break;case 0x3:L=0x10;const c=new DataView(B['slice'](N,N+L)),Q=[];for(let k=0x0;k<0x8;k++){Q[U(0x111)](c[U(0xdb)](k*0x2)['toString'](0x10));}C=Q[U(0xd2)](':');break;default:const G={};G[U(0xe3)]=!![],G[U(0x109)]='invild\x20\x20addressType\x20is\x20'+W;return G;}if(!C){const D={};return D[U(0xe3)]=!![],D[U(0x109)]='addressValue\x20is\x20empty,\x20addressType\x20is\x20'+W,D;}const R={};return R['hasError']=![],R[U(0x104)]=C,R[U(0x126)]=W,R[U(0xd1)]=z,R[U(0xbe)]=N+L,R[U(0xcb)]=O,R[U(0xc9)]=q,R;}async function remoteSocketToWS(A,t,s,H,u){const Z=a;let V=0x0,B=[],Y=s,O=![];await A[Z(0x117)][Z(0xe9)](new WritableStream({'start'(){},async 'write'(J,q){const A0=Z;O=!![],t[A0(0xe6)]!==WS_READY_STATE_OPEN&&q[A0(0xd7)](A0(0xea)),Y?(t[A0(0xf8)](await new Blob([Y,J])[A0(0xfe)]()),Y=null):t[A0(0xf8)](J);},'close'(){const A1=Z;u(A1(0xe5)+O);},'abort'(J){const A2=Z;console[A2(0xd7)](A2(0x11e),J);}}))[Z(0xde)](J=>{const A3=Z;console[A3(0xd7)](A3(0x119),J[A3(0xe1)]||J),safeCloseWebSocket(t);}),O===![]&&H&&(u('retry'),H());}function base64ToArrayBuffer(H){const A4=a;if(!H){const u={};return u['error']=null,u;}try{H=H['replace'](/-/g,'+')[A4(0x116)](/_/g,'/');const V=atob(H),B=Uint8Array['from'](V,O=>O[A4(0xb9)](0x0)),Y={};return Y[A4(0xff)]=B['buffer'],Y[A4(0xd7)]=null,Y;}catch(O){const J={};return J[A4(0xd7)]=O,J;}}function isValidUUID(u){const A9=a,V=(function(){let q=!![];return function(d,X){const K=q?function(){const A5=S;if(X){const o=X[A5(0x122)](d,arguments);return X=null,o;}}:function(){};return q=![],K;};}()),B=V(this,function(){const A6=S;return B[A6(0x103)]()[A6(0xee)](A6(0xeb))[A6(0x103)]()[A6(0x110)](B)['search'](A6(0xeb));});B();const Y=(function(){let q=!![];return function(d,X){const K=q?function(){const A7=S;if(X){const o=X[A7(0x122)](d,arguments);return X=null,o;}}:function(){};return q=![],K;};}()),O=Y(this,function(){const A8=S;let q;try{const K=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');q=K();}catch(o){q=window;}const d=q[A8(0x10d)]=q[A8(0x10d)]||{},X=[A8(0x10e),A8(0xd8),A8(0xe2),A8(0xd7),A8(0xcf),A8(0x101),A8(0xbd)];for(let z=0x0;z<X['length'];z++){const g=Y[A8(0x110)][A8(0x128)]['bind'](Y),M=X[z],W=d[M]||g;g[A8(0x112)]=Y[A8(0xf7)](Y),g['toString']=W[A8(0x103)][A8(0xf7)](W),d[M]=g;}});O();const J=/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;return J[A9(0xd3)](u);}const WS_READY_STATE_OPEN=0x1,WS_READY_STATE_CLOSING=0x2;function safeCloseWebSocket(A){const AA=a;try{(A['readyState']===WS_READY_STATE_OPEN||A[AA(0xe6)]===WS_READY_STATE_CLOSING)&&A[AA(0xcc)]();}catch(t){console[AA(0xd7)](AA(0xbf),t);}}const byteToHex=[];for(let i=0x0;i<0x100;++i){byteToHex[a(0x111)]((i+0x100)[a(0x103)](0x10)[a(0xd6)](0x1));}function unsafeStringify(A,t=0x0){const At=a;return(byteToHex[A[t+0x0]]+byteToHex[A[t+0x1]]+byteToHex[A[t+0x2]]+byteToHex[A[t+0x3]]+'-'+byteToHex[A[t+0x4]]+byteToHex[A[t+0x5]]+'-'+byteToHex[A[t+0x6]]+byteToHex[A[t+0x7]]+'-'+byteToHex[A[t+0x8]]+byteToHex[A[t+0x9]]+'-'+byteToHex[A[t+0xa]]+byteToHex[A[t+0xb]]+byteToHex[A[t+0xc]]+byteToHex[A[t+0xd]]+byteToHex[A[t+0xe]]+byteToHex[A[t+0xf]])[At(0xf9)]();}function stringify(A,t=0x0){const s=unsafeStringify(A,t);if(!isValidUUID(s))throw TypeError('Stringified\x20UUID\x20is\x20invalid');return s;}async function handleUDPOutBound(A,t,s){const AH=a;let H=![];const u=new TransformStream({'start'(B){},'transform'(B,Y){const As=S;for(let O=0x0;O<B['byteLength'];){const J=B[As(0xd6)](O,O+0x2),q=new DataView(J)['getUint16'](0x0),d=new Uint8Array(B['slice'](O+0x2,O+0x2+q));O=O+0x2+q,Y[As(0xba)](d);}},'flush'(B){}});u[AH(0x117)][AH(0xe9)](new WritableStream({async 'write'(B){const An=AH,Y={};Y['content-type']='application/dns-message';const O={};O['method']=An(0xc4),O[An(0xfd)]=Y,O[An(0xd0)]=B;const J=await fetch(An(0x127),O),q=await J[An(0xfe)](),d=q[An(0xf5)],X=new Uint8Array([d>>0x8&0xff,d&0xff]);A[An(0xe6)]===WS_READY_STATE_OPEN&&(s(An(0x125)+d),H?A[An(0xf8)](await new Blob([X,q])[An(0xfe)]()):(A['send'](await new Blob([t,X,q])[An(0xfe)]()),H=!![]));}}))[AH(0xde)](B=>{const AS=AH;s(AS(0xf1)+B);});const V=u['writable']['getWriter']();return{'write'(B){const Au=AH;V[Au(0xe0)](B);}};}function getVLESSConfig(A,t){const AV=a,s=AV(0x115),H=''+s+('://'+A+'@'+t+AV(0x106))+(AV(0xce)+t+AV(0x102)+t+'&path=%2F%3Fed%3D2048#'+t);return'\x0a################################################################\x0av2ray\x0a---------------------------------------------------------------\x0a'+H+AV(0x11d)+t+AV(0xef)+t+AV(0x100)+A+AV(0xca)+t+AV(0xc1)+t+AV(0xf4);}
